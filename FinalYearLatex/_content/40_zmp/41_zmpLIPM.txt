Rather than constraining the CoM of the robot during locomotion, the better approach is 
to control it, using the position of an inverted pendulum. This approached was developed and 
implemented by Shuuji Kajita \citep{kajita_2003_biped} in the early 2000s. 

\subsubsection*{ZMP simplification}

The inverted pendulum simplifies VukobratoviÄ‡'s ZMP by assuming that the ankle 
about which the torque is applied intersects with the ground. This intersection forms the base of the
pendulum and origin of the coordinate system in which the pendulum is defined. 
It is also assumed that the robot is capable of generating sufficient torque about 
the ankle in order to shift the position of the CoM. The mass of the foot is ignored, while the assumption
that friction holds the foot in place is retained. These simplifications yield equation 
\ref{eq:simpZMP} from equations \ref{eq:ZMPF} and \ref{eq:ZMPM}.

\begin{equation}
    \mathbf{0} = \vec{BP} \times \mathbf{R_{xyz}} - \mathbf{M_{A}}  \label{eq:simpZMP}
\end{equation}

$\mathbf{A}$ intersects with the ground, becoming the fulcrum of the pendulum. 
$R_{y}$ balances $F_{\mathbf{A}y}$ and thus $R_{y} = mg$, where $m$ is the mass of the robot. 
As the horizontal components of $\mathbf{F_{A}}$ are balanced by the horizontal friction components 
of $\mathbf{R_{xyz}}$, equation \ref{eq:simpZMP} can be solved for the $\mathbf{ZMP}(p_x,p_z)$ as follows:

\begin{align}
    p_x &= \frac{\tau_z}{mg}   \label{eq:zmpx} \\
    p_z &= \frac{-\tau_x}{mg}  \label{eq:zmpz}   
\end{align}

Equations \ref{eq:zmpx} and \ref{eq:zmpz} determine the relationship between the horizontal components
of $\mathbf{M_{A}}$ ($\tau_x, \tau_z$), the mass of the robot, and the Zero Moment Point, with respect to the fulcrum of
a pendulum.

\subsubsection*{Inverted Pendulum Derivation}

\begin{figure}[!h]
    \begin{center}
        \includegraphics[width=.45\linewidth]{_content/40_zmp/fig_LIPM_labelled_true.png}
        \caption{Inverted Pendulum $XZ$ view from above}\label{fig:LIPM}
    \end{center}
\end{figure}

The mass of an inverted pendulum of mass $m$ generates torques about the $X$ and $Z$ axes. 
These are seen in red in figure \ref{fig:LIPM}. In this instance, the pendulum is constrained
to move in the $XZ$ plane at constant height $y_c$.
Two input torques, $\tau_x$ and $\tau_z$, are applied at the base of the pendulum, along the $X$ and $Z$ axes,
in order to control the position of the pendulum.
The point $\mathbf{P}$, depicted in purple, is the $(x,z)$ position of the pendulum.
The acceleration of the pendulum is thus given by equations \ref{eq:lipmx} and \ref{eq:lipmz}.

\begin{align}
    \ddot{x} &= \frac{g}{y_c}x - \frac{1}{my_c}\tau_z   \label{eq:lipmx} \\
    \ddot{z} &= \frac{g}{y_c}z + \frac{1}{my_c}\tau_x   \label{eq:lipmz}   
\end{align}

\subsubsection*{Linear Inverted Pendulum and Zero Moment Point Model}

Rearranging the ZMP equations \ref{eq:zmpx} and \ref{eq:zmpz} for torque and then substituting into the
linear inverted pendulum equations \ref{eq:lipmx} and \ref{eq:lipmz}, yields a relationship between the ZMP and the CoM.
This model, seen in equation \ref{eq:ZMP_LIPM}, is used to drive the CoM's position during locomotion. $\mathbf{x}$
represents the vector of the position components that form the ZMP.

\begin{equation}
    \mathbf{X} = 
    \begin{bmatrix} p_x \\ p_z \end{bmatrix} =
    \begin{bmatrix}
        x - y_{c} g^{-1} \ddot{x} \\
        z - y_{c} g^{-1} \ddot{z} 
    \end{bmatrix}
\end{equation}\label{eq:ZMP_LIPM}



In order to use the model, the it must be discretized



\begin{equation}\label{eq:LIPM_stateCT}
    \begin{split}
        \frac{\delta}{\delta t}
        \begin{bmatrix}
            \mathbf{X}           \\
            \dot{\mathbf{X}}     \\ 
            \ddot{\mathbf{X}} 
        \end{bmatrix}&=
        \begin{bmatrix}
            0 & 1 & 0   \\
            0 & 0 & 1   \\ 
            0 & 0 & 0
        \end{bmatrix}
        \begin{bmatrix}
            \mathbf{X}           \\
            \dot{\mathbf{X}}     \\ 
            \ddot{\mathbf{X}} 
        \end{bmatrix} + 
        \begin{bmatrix}
            0   \\
            0   \\ 
            1 
        \end{bmatrix} u_{(x,y)}\\
        \mathbf{p}_{(x,y)}&= 
        \begin{bmatrix}
            1 & 0 & \frac{-y_{c}}{g}
        \end{bmatrix}
        \begin{bmatrix}
            x           \\
            \dot{x}     \\ 
            \ddot{x} 
        \end{bmatrix}
    \end{split}
\end{equation}

\begin{equation}\label{eq:LIPM_stateDT}
    \begin{split}
        \mathbf{x}_{(k+1)} &= \mathbf{A_d}\mathbf{x}_k+\mathbf{B_d}\mathbf{u}_k\\
        \mathbf{p}_k &= \mathbf{C_d}\mathbf{x}_k \\
    \end{split}
\end{equation}
... where:
\begin{equation}\label{eq:LIPM_discrete}
    \begin{aligned}
        \mathbf{A_d} =
        \begin{bmatrix}
            1 & T & \frac{T^{2}}{2} \\
            0 & 1 & T               \\ 
            0 & 0 & 1
        \end{bmatrix}
    \end{aligned} \:\:
    \begin{aligned}
        \mathbf{B_d} =
        \begin{bmatrix}
            \frac{T^{3}}{6} \\ \frac{T^{2}}{2} \\ T
        \end{bmatrix}
    \end{aligned} \:\:
    \begin{aligned}
        \mathbf{C_d} =
        \begin{bmatrix}
            1 & 0 & \frac{-y_{c}}{g}
        \end{bmatrix}
    \end{aligned}
\end{equation}
